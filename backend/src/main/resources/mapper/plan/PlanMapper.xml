<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gt.planit.domain.plan.model.mapper.PlanMapper">
    <!-- Plan ResultMap -->
    <resultMap id="PlanResultMap" type="com.gt.planit.domain.plan.model.dto.PlanDto">
        <id property="id" column="id"/>
        <result property="memo" column="memo"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="modifiedAt" column="modified_at"/>
        <result property="groupId" column="group_id"/>
        <result property="spotId" column="spot_id"/>
    </resultMap>

    <!-- PlanSpotResponse ResultMap -->
    <resultMap id="PlanSpotResponseResultMap" type="com.gt.planit.domain.plan.model.dto.PlanSpotResDto">
        <id property="id" column="plan_id"/>
        <result property="spotId" column="spot_id"/>
        <result property="name" column="title"/>
        <result property="badge" column="badge"/>
        <result property="location" column="location"/>
        <result property="image" column="image1"/>
        <result property="memo" column="memo"/>
        <result property="isFavorite" column="is_favorite"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="sortOrder" column="sort_order"/>
    </resultMap>

    <!-- 플랜 추가 -->
    <insert id="insertPlan" parameterType="com.gt.planit.domain.plan.model.dto.PlanDto"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO plans (
            memo,
            sort_order,
            is_deleted,
            group_id,
            spot_id
        ) VALUES (
                     #{memo},
                     #{sortOrder},
                     'F',
                     #{groupId},
                     #{spotId}
                 )
    </insert>

    <!-- 플랜 단건 조회 -->
    <select id="findById" resultMap="PlanResultMap">
        SELECT id, memo, sort_order, is_deleted, created_at, modified_at, group_id, spot_id
        FROM plans
        WHERE id = #{planId}
          AND is_deleted = 'F'
    </select>

    <!-- 그룹의 플랜 목록 조회 (스팟 정보 포함) -->
    <select id="findPlanSpotsByGroupId" resultMap="PlanSpotResponseResultMap">
        SELECT
            p.id AS plan_id,
            s.id AS spot_id,
            s.title,
            CASE s.content_type
                WHEN 'ATTRACTION' THEN '관광지'
                WHEN 'FESTIVAL'  THEN '축제'
                WHEN 'POPUP'     THEN '팝업'
            END                                                 AS badge,
            COALESCE(s.doro_addr, s.jibun_addr) AS location,
            s.image1,
            p.memo,
            CASE WHEN sl.id IS NOT NULL THEN TRUE ELSE FALSE END AS is_favorite,
            s.latitude,
            s.longitude,
            p.sort_order
        FROM plans p
                 INNER JOIN spots s ON p.spot_id = s.id
                 LEFT JOIN spot_likes sl ON s.id = sl.spot_id
            AND sl.user_id = #{userId}
            AND sl.is_deleted = 'F'
        WHERE p.group_id = #{groupId}
          AND p.is_deleted = 'F'
          AND s.is_deleted = 'F'
        ORDER BY p.sort_order ASC
    </select>

    <!-- 플랜 수정 -->
    <update id="updatePlan" parameterType="com.gt.planit.domain.plan.model.dto.PlanDto">
        UPDATE plans
        SET
        <if test="memo != null">
            memo = #{memo},
        </if>
        <if test="sortOrder != null">
            sort_order = #{sortOrder},
        </if>
        modified_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
        AND is_deleted = 'F'
    </update>

    <!-- 플랜 삭제 (soft delete) -->
    <update id="deletePlan">
        UPDATE plans
        SET is_deleted = 'T',
            modified_at = CURRENT_TIMESTAMP
        WHERE id = #{planId}
    </update>

    <!-- 그룹 내 최대 순서 조회 -->
    <select id="findMaxSortOrderByGroupId" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(sort_order), 0)
        FROM plans
        WHERE group_id = #{groupId}
          AND is_deleted = 'F'
    </select>

    <!-- 그룹에 해당 스팟이 이미 있는지 확인 -->
    <select id="existsByGroupIdAndSpotId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM plans
        WHERE group_id = #{groupId}
          AND spot_id = #{spotId}
          AND is_deleted = 'F'
    </select>

    <!-- 순서 변경 시 기존 순서들 업데이트 -->
    <update id="updateSortOrderRange">
        UPDATE plans
        SET sort_order = sort_order + #{increment},
            modified_at = CURRENT_TIMESTAMP
        WHERE group_id = #{groupId}
          AND sort_order BETWEEN #{startOrder} AND #{endOrder}
          AND is_deleted = 'F'
    </update>

</mapper>