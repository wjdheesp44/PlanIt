<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gt.planit.domain.report.model.mapper.ReportMapper">

    <!-- 사용자가 저장한 총 스팟 개수 -->
    <select id="getTotalSpotsByUser" resultType="int">
        SELECT COUNT(DISTINCT p.spot_id)
        FROM plans p
        WHERE p.group_id IN (
            SELECT gu.group_id
            FROM group_users gu
            WHERE gu.user_id = #{userId}
              AND gu.is_deleted = 'F'
        )
          AND p.is_deleted = 'F'
    </select>

    <!-- 사용자가 좋아요한 총 스팟 개수 -->
    <select id="getTotalLikesByUser" resultType="int">
        SELECT COUNT(*)
        FROM spot_likes
        WHERE user_id = #{userId}
          AND is_deleted = 'F'
    </select>

    <!-- 사용자가 작성한 총 리뷰 개수 -->
    <select id="getTotalReviewsByUser" resultType="int">
        SELECT COUNT(*)
        FROM reviews
        WHERE user_id = #{userId}
          AND is_deleted = 'F'
    </select>

    <!-- 사용자 리뷰 평균 평점 -->
    <select id="getAvgRatingByUser" resultType="double">
        SELECT COALESCE(ROUND(AVG(rating), 1), 0.0)
        FROM reviews
        WHERE user_id = #{userId}
          AND is_deleted = 'F'
    </select>

    <!-- 사용자가 방문한 지역별 통계 (TOP 5) -->
    <select id="getTopRegionsByUser" resultType="com.gt.planit.domain.report.model.entity.RegionCount">
        SELECT
            s.sido_name AS sidoName,
            COUNT(DISTINCT p.spot_id) AS count,
            ROUND(COUNT(DISTINCT p.spot_id) * 100.0 /
                  (SELECT COUNT(DISTINCT spot_id)
                   FROM plans
                   WHERE group_id IN (SELECT group_id FROM group_users WHERE user_id = #{userId} AND is_deleted = 'F')
            AND is_deleted = 'F'), 1) AS percentage
        FROM plans p
            JOIN spots sp ON p.spot_id = sp.id
            JOIN sidos s ON sp.sido_id = s.id
        WHERE p.group_id IN (
            SELECT gu.group_id
            FROM group_users gu
            WHERE gu.user_id = #{userId}
          AND gu.is_deleted = 'F'
            )
          AND p.is_deleted = 'F'
          AND sp.is_deleted = 'F'
        GROUP BY s.sido_name
        ORDER BY count DESC
            LIMIT 5
    </select>

    <!-- 사용자가 선호하는 콘텐츠 타입별 통계 -->
    <select id="getContentTypeDistributionByUser" resultType="com.gt.planit.domain.report.model.entity.ContentTypeCount">
        SELECT
            sp.content_type AS contentType,
            COUNT(*) AS count,
            ROUND(COUNT(*) * 100.0 /
                  (SELECT COUNT(*)
                   FROM plans
                   WHERE group_id IN (SELECT group_id FROM group_users WHERE user_id = #{userId} AND is_deleted = 'F')
            AND is_deleted = 'F'), 1) AS percentage
        FROM plans p
            JOIN spots sp ON p.spot_id = sp.id
        WHERE p.group_id IN (
            SELECT gu.group_id
            FROM group_users gu
            WHERE gu.user_id = #{userId}
          AND gu.is_deleted = 'F'
            )
          AND p.is_deleted = 'F'
          AND sp.is_deleted = 'F'
        GROUP BY sp.content_type
        ORDER BY count DESC
    </select>

    <!-- 사용자가 많이 사용한 해시태그 (TOP N) -->
    <select id="getTopHashtagsByUser" resultType="string">
        SELECT hashtag
        FROM review_hashtags
        WHERE user_id = #{userId}
          AND is_deleted = 'F'
        GROUP BY hashtag
        ORDER BY COUNT(*) DESC
            LIMIT #{limit}
    </select>

</mapper>